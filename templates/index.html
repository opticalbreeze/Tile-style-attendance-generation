<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤務スケジュール管理</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>勤務スケジュール管理</h1>
            <div class="period-info">
                <span id="period-display">{{ period.display_year }}年{{ period.display_month }}月度</span>
                <span id="date-range">{{ period.start_date }} ～ {{ period.end_date }}</span>
            </div>
        </header>

        <div class="main-content">
            <div class="schedule-container">
                <div class="schedule-header">
                    <div class="name-header">氏名</div>
                    <div class="dates-header-wrapper">
                        <div class="dates-header-row dates-header-months" id="dates-header-months">
                            <!-- 月ラベル行はJavaScriptで動的に生成 -->
                        </div>
                        <div class="dates-header-row dates-header-days" id="dates-header-days">
                            <!-- 日付行はJavaScriptで動的に生成 -->
                        </div>
                        <div class="dates-header-row dates-header-weekdays" id="dates-header-weekdays">
                            <!-- 曜日行はJavaScriptで動的に生成 -->
                        </div>
                    </div>
                </div>
                <div class="schedule-grid" id="schedule-grid">
                    <!-- スタッフ行はJavaScriptで動的に生成 -->
                </div>
                <div class="summary-area" id="summary-area">
                    <!-- 集計エリアはJavaScriptで動的に生成 -->
                </div>
            </div>

            <div class="shift-types-panel">
                <h3>勤務種別</h3>
                <div class="auto-attend-section">
                    <button id="auto-attend-btn" class="auto-attend-btn">自動アテンド</button>
                    <button id="reset-btn" class="reset-btn">全リセット</button>
                    <div class="settings-section" id="day-shift-only-checkboxes">
                        <!-- 日勤専門チェックボックスはJavaScriptで動的に生成 -->
                    </div>
                </div>
                
                <!-- 制約設定パネル -->
                <div class="constraints-section">
                    <h4>制約設定</h4>
                    <div class="constraint-item">
                        <label for="max-consecutive">連続24勤上限</label>
                        <select id="max-consecutive">
                            <option value="1">1回まで</option>
                            <option value="2" selected>2回まで</option>
                            <option value="3">3回まで</option>
                            <option value="4">4回まで</option>
                        </select>
                    </div>
                    <div class="constraint-item">
                        <label>
                            <input type="checkbox" id="prevent-same-pair" checked>
                            ペア連続防止
                        </label>
                    </div>
                    <div class="constraint-item">
                        <label for="same-pair-penalty">ペア防止強度</label>
                        <select id="same-pair-penalty">
                            <option value="50000">弱</option>
                            <option value="100000" selected>中</option>
                            <option value="200000">強</option>
                            <option value="500000">最強</option>
                        </select>
                    </div>
                    <div class="constraint-item">
                        <label for="hours-balance-penalty">時間均等化</label>
                        <select id="hours-balance-penalty">
                            <option value="10">弱</option>
                            <option value="100" selected>中</option>
                            <option value="500">強</option>
                            <option value="1000">最強</option>
                        </select>
                    </div>
                    <div class="constraint-item">
                        <label for="required-weekday-night">平日24勤人数</label>
                        <select id="required-weekday-night">
                            <option value="2">2名</option>
                            <option value="3" selected>3名</option>
                            <option value="4">4名</option>
                            <option value="5">5名</option>
                        </select>
                    </div>
                    <div class="constraint-item">
                        <label for="required-weekend-night">土日24勤人数</label>
                        <select id="required-weekend-night">
                            <option value="2">2名</option>
                            <option value="3" selected>3名</option>
                            <option value="4">4名</option>
                            <option value="5">5名</option>
                        </select>
                    </div>
                    <button id="apply-constraints-btn" class="apply-constraints-btn">設定を適用</button>
                </div>
                <div class="shift-tiles" id="shift-tiles">
                    <div class="shift-tile" data-shift="24A" draggable="true">
                        <span>24A</span>
                    </div>
                    <div class="shift-tile" data-shift="24B" draggable="true">
                        <span>24B</span>
                    </div>
                    <div class="shift-tile" data-shift="日勤" draggable="true">
                        <span>日勤</span>
                    </div>
                    <div class="shift-tile" data-shift="夜勤" draggable="true">
                        <span>夜勤</span>
                    </div>
                    <div class="shift-tile" data-shift="明" draggable="true">
                        <span>明</span>
                    </div>
                    <div class="shift-tile" data-shift="休" draggable="true">
                        <span>休</span>
                    </div>
                    <div class="shift-tile" data-shift="有休" draggable="true">
                        <span>有休</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 期間データと設定をJavaScriptに渡す
        const periodData = {{ period | tojson }};
        const config = {{ config | tojson }};
        const dates = periodData.dates;
        
        // グローバルに公開
        window.appData = {
            dates: dates,
            staffList: config.staff.list,
            periodData: periodData,
            config: config
        };
    </script>
    <!-- モジュール読み込み（依存関係順） -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/schedule-state.js') }}"></script>
    <script src="{{ url_for('static', filename='js/schedule-grid.js') }}"></script>
    <script src="{{ url_for('static', filename='js/drag-drop.js') }}"></script>
    <script src="{{ url_for('static', filename='js/shift-operations.js') }}"></script>
    <script src="{{ url_for('static', filename='js/summary.js') }}"></script>
    <script src="{{ url_for('static', filename='js/constraints-ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auto-attend-controller.js') }}"></script>
    <!-- アルゴリズム -->
    <script src="{{ url_for('static', filename='js/optimized_assign.js') }}"></script>
    <script src="{{ url_for('static', filename='js/csp_scheduler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/nurse_shift_algorithm.js') }}"></script>
    <!-- エントリーポイント -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // appData設定後に初期化を実行
        window.addEventListener('load', function() {
            if (window.doInitialize) {
                window.doInitialize();
            } else if (window.initializeSchedule) {
                // フォールバック: 直接初期化関数を呼ぶ
                window.initializeSchedule();
                if (window.setupDragAndDrop) window.setupDragAndDrop();
                if (window.initializeSummary) window.initializeSummary();
                if (window.setupAutoAttend) window.setupAutoAttend();
            }
        });
    </script>
</body>
</html>
